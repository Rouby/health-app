// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["linux-arm64-openssl-1.1.x", "debian-openssl-1.1.x", "native"]
  output        = "../src/__generated__/prisma"
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model User {
  id    String @id @default(cuid())
  email String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  password Password?

  name           String
  firstDayOfWeek Int    @default(1) // 0 = Sunday, 1 = Monday

  sexActs        SexAct[]
  daysWithoutSex DayWithoutSex[]

  partner         User?   @relation("Partner", fields: [partnerId], references: [id], onDelete: Restrict, onUpdate: Restrict)
  partnerId       String? @unique
  partnerProposer User?   @relation("Partner") // This is the user that proposed the current user as a partner

  mood Mood?

  pushNotifications PushNotification[]

  sexInterests SexInterestUserIntent[]
}

model Mood {
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId String @unique

  validUntil DateTime?

  inMoodFor String?

  @@id([userId])
}

model Password {
  hash String

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId String @unique
}

enum Initiator {
  USER
  PARTNER
}

model SexAct {
  id String @id @default(cuid())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId String

  dateTime          DateTime
  duration          String?
  location          String?
  initiator         Initiator
  foreplayOnUser    String?
  foreplayOnPartner String?
  position          String
  userFinished      Boolean
  partnerFinished   Boolean

  @@index([userId])
}

model DayWithoutSex {
  dateTime DateTime

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId String

  onPeriod Boolean @default(false)

  @@id([dateTime, userId])
  @@index([userId])
}

model PushNotification {
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId String

  endpoint String @unique
  keys     Json

  @@id([endpoint, userId])
  @@index([userId])
}

model SexInterest {
  id String @id @default(cuid())

  translationKey String @unique
  defaultMessage String
  imagePath      String

  descriptionTranslationKey String
  descriptionDefaultMessage String @db.Text

  tags Tag[]

  userIntents SexInterestUserIntent[]
}

model SexInterestUserIntent {
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId String

  sexInterest   SexInterest @relation(fields: [sexInterestId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  sexInterestId String

  interested       Boolean
  noticedByPartner Boolean @default(false)
  done             Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([userId, sexInterestId])
  @@unique([userId, sexInterestId])
  @@index([userId])
  @@index([sexInterestId])
}

model Tag {
  id String @id @default(cuid())

  translationKey String @unique
  defaultMessage String

  sexInterests SexInterest[]
}
